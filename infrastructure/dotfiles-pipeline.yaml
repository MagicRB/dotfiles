---
resources:
- name: dotfiles-git
  type: git
  icon: github
  source:
    uri: https://github.com/MagicRB/dotfiles.git

- name: nix-image
  type: registry-image
  icon: docker
  source:
    repository: magicrb/nix
    tag: latest

- name: push-nix-image
  type: registry-image
  icon: docker
  source:
    repository: magicrb/nix
    username: magicrb
    password: ((docker_hub.magicrb_token))

jobs:
- name: test-build
  public: true
  plan:
    - get: dotfiles-git
      trigger: true
      params: { submodules: none }
    - get: nix-image
      trigger: false
    - task: build
      image: nix-image
      config:
        platform: linux
        inputs:
          - name: dotfiles-git
            path: src/
        run:
          path: /bin/entrypoint.sh
          args:
            - -c
            - |
              out=$(pwd)
              cd src/nix

              nix -vv --log-format raw -L  --experimental-features 'nix-command flakes' build --out-link $out/nix.tar.gz .#dockerImages.x86_64-linux.nix.build
    - put: push-nix-image
      params:
        image: nix.tar.gz
